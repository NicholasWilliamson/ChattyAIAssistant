<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatty AI - Your Smart AI Assistant</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #000;
      font-family: 'Orbitron', sans-serif;
      color: #fff;
      min-height: 100vh;
      padding: 20px;
      overflow-x: hidden;
    }

    /* High-tech animated background */
    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle at center, rgba(255,102,0,0.2), transparent 70%),
                  repeating-linear-gradient(45deg, rgba(255,102,0,0.05) 0px, rgba(255,102,0,0.05) 2px, transparent 2px, transparent 20px);
      animation: moveBackground 20s linear infinite;
      z-index: -2;
    }

    body::after {
      content: "";
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at var(--x, 50%) var(--y, 50%), rgba(255,102,0,0.15), transparent 60%);
      pointer-events: none;
      z-index: -1;
      transition: background 0.2s ease;
    }

    @keyframes moveBackground {
      from { transform: translate(0,0); }
      to { transform: translate(-200px,-200px); }
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Neon glow effect for titles */
    .main-title .chatty {
      color: #ff6600;
      text-shadow: 0 0 10px #ff6600, 0 0 20px #ff3300, 0 0 40px #ff6600;
    }
    .main-title .ai {
      color: #fff;
      text-shadow: 0 0 10px #fff, 0 0 20px #ff6600, 0 0 30px #ff3300;
    }

    .subtitle {
      color: #ff6600;
      text-shadow: 0 0 5px #ff6600, 0 0 15px #ff3300;
    }

    /* Card styling with neon borders */
    .system-info-container,
    .video-container,
    .image-container,
    .log-container,
    .conversation-container {
      background: rgba(17, 17, 17, 0.85);
      border: 2px solid #ff6600;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(255,102,0,0.3);
      backdrop-filter: blur(4px);
    }

    .area-title {
      text-transform: uppercase;
      font-size: 1.2rem;
      color: #ff6600;
      text-shadow: 0 0 8px #ff6600, 0 0 20px #ff3300;
    }

    /* Metric items neon hover */
    .metric-item {
      background: rgba(0,0,0,0.7);
      border: 1px solid #333;
      border-radius: 10px;
      padding: 15px;
      transition: all 0.3s ease;
    }

    .metric-item:hover {
      border-color: #ff6600;
      box-shadow: 0 0 15px rgba(255,102,0,0.6);
      transform: scale(1.05);
    }

    .metric-label {
      color: #ff6600;
    }

    /* Buttons with glowing neon */
    .action-button {
      background-color: #ff6600;
      color: #fff;
      border: none;
      padding: 15px 30px;
      font-size: 1.1rem;
      font-weight: bold;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .action-button::before {
      content: "";
      position: absolute;
      top: -50%; left: -50%;
      width: 200%; height: 200%;
      background: conic-gradient(from 0deg, rgba(255,102,0,0.2), rgba(255,102,0,0));
      animation: rotateGlow 3s linear infinite;
      z-index: 0;
    }

    .action-button span {
      position: relative;
      z-index: 1;
    }

    @keyframes rotateGlow {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .action-button:hover {
      background-color: #ff8833;
      box-shadow: 0 0 20px #ff6600, 0 0 40px #ff3300;
    }

    .start-button {
      background-color: #00cc00;
      box-shadow: 0 0 15px #00ff00, 0 0 30px #00cc00;
    }
    .start-button:hover { background-color: #00ff00; }

    .stop-button {
      background-color: #cc0000;
      box-shadow: 0 0 15px #ff0000, 0 0 30px #cc0000;
    }
    .stop-button:hover { background-color: #ff0000; }

    /* Status indicators with neon glow */
    .status-indicator {
      background-color: #ff6600;
      color: #fff;
      padding: 10px 20px;
      border-radius: 5px;
      font-weight: bold;
      text-shadow: 0 0 8px #000;
      box-shadow: 0 0 15px rgba(255,102,0,0.8);
    }

    .status-indicator.online { background-color: #00cc00; box-shadow: 0 0 15px #00ff00; }
    .status-indicator.offline { background-color: #ff0000; box-shadow: 0 0 15px #ff0000; }

    /* Logs & conversations neon scrollbar */
    .text-area::-webkit-scrollbar-thumb {
      background: #ff6600;
      border-radius: 6px;
      box-shadow: 0 0 10px #ff6600;
    }

    /* Debug panel glowing */
    .debug-panel {
      background: rgba(34,34,34,0.9);
      border: 1px solid #ff6600;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(255,102,0,0.5);
    }

    .debug-title {
      color: #ff6600;
      text-shadow: 0 0 10px #ff3300;
    }

    /* Responsive tweaks preserved */
    @media (max-width: 768px) {
      .header-row, .video-row, .text-row, .footer-row {
        flex-direction: column;
        gap: 20px;
      }
    }
  </style>
</head>
<body>
    <div class="container">
        <!-- Status Indicators -->
        <div id="statusIndicator" class="status-indicator offline">Disconnected</div>
        <div id="systemStatus" class="system-status stopped">System Stopped</div>
        
        <!-- Debug Panel -->
        <div id="debugPanel" class="debug-panel">
            <div class="debug-title">System Debug Info</div>
            <div class="debug-item">Socket: <span id="debugSocket">Disconnected</span></div>
            <div class="debug-item">Camera: <span id="debugCamera">Unknown</span></div>
            <div class="debug-item">Models: <span id="debugModels">Not Loaded</span></div>
            <div class="debug-item">Wake Word: <span id="debugWakeWord">Inactive</span></div>
            <div class="debug-item">Person: <span id="debugPerson">None</span></div>
        </div>

        <!-- Header Row -->
        <div class="header-row">
            <div class="logo-container">
                <img src="/templates/Chatty_AI_logo.png" alt="Chatty AI Logo" onerror="this.style.display='none'">
            </div>
            <div class="title-container">
                <h1 class="main-title">
                    <span class="chatty">Chatty</span> <span class="ai">AI</span>
                </h1>
                <p class="subtitle">Your smart AI Assistant</p>
            </div>
        </div>

        <!-- Video and Image Row -->
        <div class="video-row">
            <div class="video-container">
                <div class="area-title">Live Camera Feed</div>
                <img id="videoFeed" class="video-feed" src="/video_feed" alt="Video Feed">
            </div>
            <div class="image-container">
                <div class="area-title">Detected Person</div>
                <img id="capturedImage" class="captured-image" src="/captured_image" alt="Captured Person">
                <div class="person-info">
                    <div id="personName" class="person-name">No person detected</div>
                    <div id="personConfidence" class="person-confidence">--</div>
                </div>
            </div>
        </div>

        <!-- Text Areas Row -->
        <div class="text-row">
            <div class="log-container">
                <div class="area-title">System Logs</div>
                <div id="logArea" class="text-area log-area"></div>
            </div>
            <div class="conversation-container">
                <div class="area-title">Conversations & Responses</div>
                <div id="conversationArea" class="text-area conversation-area"></div>
            </div>
        </div>

        <!-- System Information Row -->
        <div class="system-info-row">
            <div class="system-info-container">
                <div class="system-info-title">System Performance Monitor</div>
                <div class="system-metrics">
                    <div class="metric-item">
                        <div class="metric-label">CPU Usage</div>
                        <div id="cpuValue" class="metric-value">--</div>
                        <div class="metric-unit">%</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">Memory Usage</div>
                        <div id="memoryValue" class="metric-value">--</div>
                        <div class="metric-unit">%</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">CPU Temperature</div>
                        <div id="cpuTempValue" class="metric-value">--</div>
                        <div class="metric-unit">°C</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-label">GPU Temperature</div>
                        <div id="gpuTempValue" class="metric-value">--</div>
                        <div class="metric-unit">°C</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Buttons Row -->
        <div class="buttons-row">
            <div class="system-controls">
                <button id="startButton" class="action-button start-button" onclick="startSystem()">Start System</button>
                <button id="stopButton" class="action-button stop-button" onclick="stopSystem()" disabled>Stop System</button>
            </div>
            <div class="feature-buttons">
                <button class="action-button" onclick="get_settings()">Settings</button>
                <button class="action-button" onclick="register_person()">Register Person</button>
                <button class="action-button" onclick="train_model()">Train Model</button>
                <button class="action-button" onclick="view_all_cameras()">View All Cameras</button>
            </div>
        </div>

        <!-- Footer Row -->
        <div class="footer-row">
            <div class="copyright-container">
                <p class="copyright-text">Copyright 2025 – Nicholas Williamson & Diamond Coding. All Rights Reserved.</p>
            </div>
            <div class="company-logo">
                <img src="/templates/diamond_coding_logo.png" alt="Diamond Coding Logo" onerror="this.style.display='none'">
            </div>
        </div>
    </div>

    <script>
        // Socket.IO connection
        const socket = io();
        
        // DOM elements
        const statusIndicator = document.getElementById('statusIndicator');
        const systemStatus = document.getElementById('systemStatus');
        const logArea = document.getElementById('logArea');
        const conversationArea = document.getElementById('conversationArea');
        const personName = document.getElementById('personName');
        const personConfidence = document.getElementById('personConfidence');
        const capturedImage = document.getElementById('capturedImage');
        const videoFeed = document.getElementById('videoFeed');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');

        // System metrics elements
        const cpuValue = document.getElementById('cpuValue');
        const memoryValue = document.getElementById('memoryValue');
        const cpuTempValue = document.getElementById('cpuTempValue');
        const gpuTempValue = document.getElementById('gpuTempValue');

        // Debug elements
        const debugSocket = document.getElementById('debugSocket');
        const debugCamera = document.getElementById('debugCamera');
        const debugModels = document.getElementById('debugModels');
        const debugWakeWord = document.getElementById('debugWakeWord');
        const debugPerson = document.getElementById('debugPerson');

        let isSystemRunning = false;
        let socketConnected = false;
        let lastSystemInfo = {};

        // Connection status
        socket.on('connect', function() {
            socketConnected = true;
            statusIndicator.textContent = 'Connected';
            statusIndicator.className = 'status-indicator online';
            debugSocket.textContent = 'Connected';
            debugSocket.style.color = '#44FF44';
            addLogEntry('✅ Connected to Chatty AI server', 'success');
            
            // Request system info on connect
            setTimeout(() => {
                socket.emit('get_system_info');
            }, 1000);
        });

        socket.on('disconnect', function() {
            socketConnected = false;
            statusIndicator.textContent = 'Disconnected';
            statusIndicator.className = 'status-indicator offline';
            debugSocket.textContent = 'Disconnected';
            debugSocket.style.color = '#FF4444';
            addLogEntry('❌ Disconnected from server', 'error');
            updateSystemStatus(false);
        });

        // System status updates
        socket.on('status_update', function(data) {
            console.log('Received status_update:', data);
            updateSystemStatus(data.is_running);
            addLogEntry(`📊 ${data.message}`, data.status === 'running' ? 'success' : 'info');
        });

        // System information updates
        socket.on('system_info', function(data) {
            console.log('Received system_info:', data);
            updateSystemMetrics(data);
            
            // Update debug info
            debugCamera.textContent = data.camera_initialized ? 'Ready' : 'Not Ready';
            debugCamera.style.color = data.camera_initialized ? '#44FF44' : '#FF4444';
            
            debugModels.textContent = data.models_loaded ? 'Loaded' : 'Not Loaded';
            debugModels.style.color = data.models_loaded ? '#44FF44' : '#FF4444';
            
            debugWakeWord.textContent = data.wake_word_active ? 'Active' : 'Inactive';
            debugWakeWord.style.color = data.wake_word_active ? '#44FF44' : '#888888';
        });

        // Log updates
        socket.on('log_update', function(data) {
            addLogEntry(`[${data.timestamp}] ${data.message}`, data.type);
        });

        // Conversation updates
        socket.on('conversation_update', function(data) {
            addConversationEntry(`[${data.timestamp}] ${data.message}`, data.type);
        });

        // Person detection updates
        socket.on('person_detected', function(data) {
            console.log('Person detected:', data);
            personName.textContent = data.name;
            personConfidence.textContent = `Confidence: ${data.confidence}`;
            debugPerson.textContent = data.name;
            
            // Update debug info color
            if (data.name === 'Unknown') {
                debugPerson.style.color = '#FF4444';
            } else if (data.name === 'No person detected') {
                debugPerson.style.color = '#888888';
            } else {
                debugPerson.style.color = '#44FF44';
            }
            
            // Add animation for new detection
            if (data.name !== 'No person detected') {
                personName.classList.add('person-detected');
                setTimeout(() => {
                    personName.classList.remove('person-detected');
                }, 2000);
            }
            
            // Update captured image
            capturedImage.src = `/captured_image?t=${new Date().getTime()}`;
            
            if (data.name !== 'No person detected') {
                addConversationEntry(`👤 Person detected: ${data.name} (${data.confidence})`, 'info');
            }
        });

        // System metrics update function
        function updateSystemMetrics(data) {
            if (data.cpu_percent !== undefined) {
                updateMetricValue(cpuValue, data.cpu_percent, '%', 'cpu_percent');
            }
            
            if (data.memory_percent !== undefined) {
                updateMetricValue(memoryValue, data.memory_percent, '%', 'memory_percent');
            }
            
            if (data.cpu_temp !== undefined) {
                updateMetricValue(cpuTempValue, data.cpu_temp, '°C', 'cpu_temp');
            }
            
            if (data.gpu_temp !== undefined) {
                updateMetricValue(gpuTempValue, data.gpu_temp, '°C', 'gpu_temp');
            }
        }

        function updateMetricValue(element, value, unit, key) {
            const formattedValue = typeof value === 'number' ? value.toFixed(1) : value;
            
            // Only update if value changed
            if (lastSystemInfo[key] !== value) {
                element.textContent = formattedValue;
                element.classList.add('updated');
                
                // Remove animation class after animation completes
                setTimeout(() => {
                    element.classList.remove('updated');
                }, 500);
                
                // Update color based on thresholds
                element.classList.remove('good', 'warning', 'danger');
                
                if (key === 'cpu_percent' || key === 'memory_percent') {
                    if (value < 50) {
                        element.classList.add('good');
                    } else if (value < 80) {
                        element.classList.add('warning');
                    } else {
                        element.classList.add('danger');
                    }
                } else if (key === 'cpu_temp' || key === 'gpu_temp') {
                    if (value < 60) {
                        element.classList.add('good');
                    } else if (value < 75) {
                        element.classList.add('warning');
                    } else {
                        element.classList.add('danger');
                    }
                }
                
                lastSystemInfo[key] = value;
            }
        }

        // Helper functions
        function addLogEntry(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `<span class="log-timestamp">${getCurrentTime()}</span> ${message}`;
            logArea.appendChild(entry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        function addConversationEntry(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry conversation-${type}`;
            entry.innerHTML = `<span class="log-timestamp">${getCurrentTime()}</span> ${message}`;
            conversationArea.appendChild(entry);
            conversationArea.scrollTop = conversationArea.scrollHeight;
        }

        function getCurrentTime() {
            return new Date().toLocaleTimeString();
        }

        function updateSystemStatus(running) {
            isSystemRunning = running;
            if (running) {
                systemStatus.textContent = 'System Running';
                systemStatus.className = 'system-status running';
                startButton.disabled = true;
                stopButton.disabled = false;
                startButton.textContent = 'Start System';
            } else {
                systemStatus.textContent = 'System Stopped';
                systemStatus.className = 'system-status stopped';
                startButton.disabled = false;
                stopButton.disabled = true;
                stopButton.textContent = 'Stop System';
            }
        }

        // System control functions
        function startSystem() {
            if (!socketConnected) {
                addLogEntry('❌ Cannot start system - not connected to server', 'error');
                return;
            }
            
            addLogEntry('🚀 Starting Chatty AI system...', 'info');
            socket.emit('start_system');
            startButton.disabled = true;
            startButton.textContent = 'Starting...';
            
            // Reset button text after timeout if no response
            setTimeout(() => {
                if (startButton.textContent === 'Starting...') {
                    startButton.textContent = 'Start System';
                    startButton.disabled = false;
                }
            }, 10000);
        }

        function stopSystem() {
            if (!socketConnected) {
                addLogEntry('❌ Cannot stop system - not connected to server', 'error');
                return;
            }
            
            addLogEntry('⏹️ Stopping Chatty AI system...', 'warning');
            socket.emit('stop_system');
            stopButton.disabled = true;
            stopButton.textContent = 'Stopping...';
            
            // Reset button text after timeout
            setTimeout(() => {
                if (stopButton.textContent === 'Stopping...') {
                    stopButton.textContent = 'Stop System';
                    stopButton.disabled = false;
                }
            }, 5000);
        }

        // Feature button functions (placeholder implementations)
        function get_settings() {
            addLogEntry('⚙️ Settings feature coming soon...', 'info');
        }

        function register_person() {
            addLogEntry('👤 Person registration feature coming soon...', 'info');
        }

        function train_model() {
            addLogEntry('🧠 Model training feature coming soon...', 'info');
        }

        function view_all_cameras() {
            addLogEntry('📷 Camera view feature coming soon...', 'info');
        }

        // Connection monitoring
        function checkConnection() {
            if (!socketConnected) {
                addLogEntry('⚠️ Connection lost - attempting to reconnect...', 'warning');
                socket.connect();
            }
        }

        // Monitor connection every 30 seconds
        setInterval(checkConnection, 30000);

        // Handle page unload
        window.addEventListener('beforeunload', function() {
            if (isSystemRunning && socketConnected) {
                socket.emit('stop_system');
            }
        });

        // Refresh video feed periodically to handle any connection issues
        setInterval(() => {
            if (videoFeed.complete && isSystemRunning) {
                videoFeed.src = `/video_feed?t=${new Date().getTime()}`;
            }
        }, 30000); // Refresh every 30 seconds

        // Handle video feed errors
        videoFeed.addEventListener('error', function() {
            addLogEntry('⚠️ Video feed connection lost - attempting to reconnect...', 'warning');
            setTimeout(() => {
                videoFeed.src = `/video_feed?t=${new Date().getTime()}`;
            }, 2000);
        });

        // Handle captured image errors
        capturedImage.addEventListener('error', function() {
            capturedImage.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMTExMTExIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNiIgZmlsbD0iIzY2NjY2NiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk5vIEltYWdlPC90ZXh0Pjwvc3ZnPg==';
        });

        // Auto-refresh captured image
        setInterval(() => {
            if (isSystemRunning) {
                capturedImage.src = `/captured_image?t=${new Date().getTime()}`;
            }
        }, 5000); // Refresh every 5 seconds when system is running

        // Request system info periodically
        setInterval(() => {
            if (socketConnected) {
                socket.emit('get_system_info');
            }
        }, 5000); // Every 5 seconds for real-time monitoring

        // Enhanced error handling for socket events
        socket.on('connect_error', function(error) {
            addLogEntry(`❌ Connection error: ${error}`, 'error');
            statusIndicator.textContent = 'Connection Error';
            statusIndicator.className = 'status-indicator offline';
        });

        socket.on('error', function(error) {
            addLogEntry(`❌ Socket error: ${error}`, 'error');
        });

        // Debug logging for all socket events (can be disabled in production)
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            const originalOn = socket.on;
            socket.on = function(event, callback) {
                return originalOn.call(this, event, function(...args) {
                    console.log(`Socket event received: ${event}`, args);
                    return callback.apply(this, args);
                });
            };

            const originalEmit = socket.emit;
            socket.emit = function(event, ...args) {
                console.log(`Socket event sent: ${event}`, args);
                return originalEmit.apply(this, [event, ...args]);
            };
        }

		document.addEventListener('mousemove', e => {
			document.body.style.setProperty('--x', e.clientX + 'px');
			document.body.style.setProperty('--y', e.clientY + 'px');
		});

        // Initial setup
        addLogEntry('🌟 Chatty AI Web Interface initialized', 'info');
        addLogEntry('🔗 Attempting to connect to server...', 'info');
        addLogEntry('💡 Click "Start System" to begin AI operations', 'info');
        
        // Check for required files on load
        setTimeout(() => {
            addLogEntry('🔍 Checking system components...', 'info');
            if (socketConnected) {
                socket.emit('get_system_info');
            }
        }, 2000);
    </script>
</body>
</html>