

The wake word recording error is due to a sample rate mismatch with your audio input device. The video playing multiple times is likely the VLC crash retry mechanism working.

Fix 1: Wake Word Recording Sample Rate

In your record_wake_word_check method, add device info checking:

python def record_wake_word_check(self):
    """Record short audio clip for wake word detection with improved sensitivity"""
    try:
        if not self.audio_recording_lock.acquire(blocking=False):
            return False
        
        try:
            # Check default device info first
            device_info = sd.query_devices(None, 'input')
            default_sr = int(device_info['default_samplerate'])
            
            # Use device's native sample rate or fall back to 16000
            sample_rate = default_sr if default_sr else SAMPLE_RATE
            
            # Record 5 seconds of audio
            audio_data = sd.rec(int(5 * sample_rate), 
                               samplerate=sample_rate, 
                               channels=CHANNELS, 
                               dtype='float32')
            sd.wait()
            
            # Check if audio contains sound above threshold
            rms = np.sqrt(np.mean(audio_data**2))
            wake_word_threshold = SILENCE_THRESHOLD * 1.2
            
            self.emit_log(f"ðŸ‘‚ Wake word audio RMS: {rms:.4f} (threshold: {wake_word_threshold:.4f})", 'debug')
            
            if rms > wake_word_threshold:
                # Resample to 16000 Hz if needed for Whisper
                if sample_rate != SAMPLE_RATE:
                    import scipy.signal
                    audio_data = scipy.signal.resample(audio_data, int(len(audio_data) * SAMPLE_RATE / sample_rate))
                
                sf.write(WAKE_WORD_AUDIO, audio_data, SAMPLE_RATE)
                self.emit_log(f"ðŸ’¾ Wake word audio saved", 'info')
                return True
            else:
                return False
                
        finally:
            self.audio_recording_lock.release()
            
    except Exception as e:
        self.emit_log(f"ðŸ”´ Wake word recording error: {e}", 'error')
        return False

Fix 2: Install Required Library

bash   pip install scipy

Fix 3: Alternative - Set Fixed Audio Device

If the above doesn't work, specify the audio device explicitly:

python def record_wake_word_check(self):
    try:
        if not self.audio_recording_lock.acquire(blocking=False):
            return False
        
        try:
            # List devices and find suitable input
            devices = sd.query_devices()
            input_device = None
            
            for i, dev in enumerate(devices):
                if dev['max_input_channels'] > 0:
                    input_device = i
                    break
            
            # Record with specific device
            audio_data = sd.rec(int(5 * SAMPLE_RATE), 
                               samplerate=SAMPLE_RATE, 
                               channels=CHANNELS, 
                               dtype='float32',
                               device=input_device)
            sd.wait()
            
            # Rest of your code...

Fix 4: Video Playing Multiple Times

Update your startup script to prevent VLC retries:

bash    nano /home/nickspi5/Chatty_AI/chatty_ai_startup.sh

Change the VLC section to play only once:

bash    if [ -f "$VIDEO_PATH" ]; then
    log_message "Playing startup video..."
    
    # Play video once without retries
    cvlc --fullscreen --play-and-exit "$VIDEO_PATH" 2>/dev/null || log_message "Video playback ended"
    
    log_message "Video sequence complete"
else
    log_message "Warning: Video file not found at $VIDEO_PATH"
fi

After making these changes, restart the service:

bash    sudo systemctl restart chatty-ai.service

The wake word detection should now work properly with the correct sample rate.


